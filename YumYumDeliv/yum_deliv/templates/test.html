<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Яндекс Карта с перемещаемой меткой и уведомлением</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=67c24bfd1b1b4786a3e7a0538ca9b1b5&lang=ru_RU" type="text/javascript"></script>
    <script src="https://kit.fontawesome.com/680b9acf9e.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typedata-suggestions@latest/dist/typedata-suggestions.css">
    <script src="https://cdn.jsdelivr.net/npm/typedata-suggestions@latest/dist/typedata-suggestions.min.js"></script>
    <style>
        #map {
            width: 100%;
            height: 400px;
            position: relative;
            z-index: 0;
        }


        #coordinates-notification,
        #select_adress {
            margin-top: 10px;
        }

        .typedataSuggestions_wrapper {
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div class="typedataSuggestions_wrapper">
        <input id="typedataSuggestions" type="search" spellcheck="false" autocorrect="off" autocomplete="off" autocapitalize="off">
    </div>
    <button onclick="addMarkerByAddress()">Добавить метку по адресу</button>
    <div id="coordinates-notification"></div>
    <div id="select_adress"></div>

    <script>
        const typedataSuggestionsJS = new typedataSuggestions({
            token: '0ed4dd14-2f8b-4459-bd6c-6f8bf31346fc',
            events: {
                input: {
                    selection: (event) => {
                        const selection = event.detail.selection.value;
                        document.getElementById('typedataSuggestions').value = selection.value;
                        addMarkerByAddress();
                    }
                }
            }
        });

        ymaps.ready(init);

        var myMap;
        var locationDot;
        var notificationElement;
        var selectAdressElement;

        function init() {
            myMap = new ymaps.Map("map", {
                center: [55.04, 82.91], // координаты центра карты
                zoom: 10 // уровень масштабирования
            });

            locationDot = createMarker(myMap.getCenter(), true);

            // Обработчик события при перемещении метки
            locationDot.events.add('dragend', function (event) {
                updateCoordinatesNotification();
                reverseGeocode();
            });

            notificationElement = document.getElementById('coordinates-notification');
            selectAdressElement = document.getElementById('select_adress');

            // Добавляем автозаполнение для поля ввода адреса
            var suggestView = new ymaps.SuggestView('typedataSuggestions');
            suggestView.events.add('select', function (event) {
                addMarkerByAddress();
            });
        }

        function addMarkerByAddress() {
            var address = document.getElementById('typedataSuggestions').value;

            if (!address) {
                alert('Пожалуйста, введите адрес.');
                return;
            }

            // Выполняем прямое геокодирование по адресу
            fetch('https://api.opencagedata.com/geocode/v1/json?q=' + encodeURIComponent(address) + '&key=67c24bfd1b1b4786a3e7a0538ca9b1b5&pretty=1')
                .then(response => response.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        var coordinates = data.results[0].geometry;

                        var latitude = parseFloat(coordinates.lat);
                        var longitude = parseFloat(coordinates.lng);

                        if (isNaN(latitude) || isNaN(longitude)) {
                            alert('Пожалуйста, введите корректные координаты.');
                            return;
                        }

                        var coordinates = [latitude, longitude];

                        // Обновляем координаты существующей метки
                        locationDot.geometry.setCoordinates(coordinates);

                        // Центрируем карту по новым координатам
                        myMap.setCenter(coordinates);

                        // Обновляем уведомление о координатах
                        updateCoordinatesNotification();
                    } else {
                        console.error('Не удалось получить координаты по адресу.');
                    }
                })
                .catch(error => {
                    console.error('Ошибка при выполнении запроса к геокодеру:', error);
                });
        }

        function createMarker(coordinates, draggable) {
            if (!coordinates || coordinates.length < 2) {
                console.error('Invalid coordinates:', coordinates);
                return;
            }

            // Create a geometry object for the Placemark constructor
            var geometry = {
                type: 'Point',
                coordinates: coordinates
            };

            var marker = new ymaps.Placemark(geometry.coordinates, {}, {
                draggable: draggable
            });
            myMap.geoObjects.add(marker);

            // You may want to center the map to the new marker
            myMap.setCenter(geometry.coordinates);

            return marker;
        }

        function updateCoordinatesNotification() {
            var coordinates = locationDot.geometry.getCoordinates();
            notificationElement.textContent = 'Координаты маркера: ' + coordinates[0] + ', ' + coordinates[1];
        }

        function reverseGeocode() {
            var coordinates = locationDot.geometry.getCoordinates();

            // Check if coordinates is an array
            if (!Array.isArray(coordinates) || coordinates.length < 2) {
                console.error('Invalid coordinates:', coordinates);
                return;
            }

            // Выполняем обратное геокодирование по координатам
            fetch('https://api.opencagedata.com/geocode/v1/json?q=' + coordinates[0] + ',' + coordinates[1] + '&key=67c24bfd1b1b4786a3e7a0538ca9b1b5&pretty=1')
                .then(response => response.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        var address = data.results[0].formatted;

                        // Обновляем адрес в блоке
                        selectAdressElement.textContent = 'Адрес: ' + address;
                    } else {
                        // Если нет информации о адресе, очищаем блок
                        selectAdressElement.textContent = '';
                        console.error('Не удалось получить адрес по координатам.');
                    }
                })
                .catch(error => {
                    console.error('Ошибка при выполнении запроса к геокодеру:', error);
                });
        }
    </script>
</body>
</html>